const consoleLog = document.getElementById('consoleLog');
const consoleContainer = document.getElementById('consoleContainer');
const userInput = document.getElementById('userInput');
const startBtn = document.getElementById('startBtn');
const statusDot = document.getElementById('statusDot');
const statusText = document.getElementById('statusText');
const welcomeScreen = document.getElementById('welcomeScreen');

let questionCount = 0;
let maxQuestions = 6;
let callerInfo = {};
let timerInterval = null;
let currentIncident = null;

// Verf√ºgbare Notfall-Szenarien
const incidents = [
    {
        type: "WOHNUNGSBRAND",
        icon: "üî•",
        initialPanic: "Es brennt! Oh Gott, es brennt! √úberall ist Rauch!",
        details: "Feuer im Mehrfamilienhaus, 3. Stock. Starke Rauchentwicklung. Personen m√∂glicherweise eingeschlossen.",
        units: "2x L√∂schzug + Drehleiter + RTW",
        priority: "PRIORIT√ÑT 1 - SOFORT",
        keywords: ["feuer", "brand", "rauch", "brennt", "flammen", "qualm"],
        emotionalState: "panisch",
        location: "Musterstra√üe 47, 3. OG links"
    },
    {
        type: "HERZINFARKT",
        icon: "üíî",
        initialPanic: "Mein Mann! Er fasst sich an die Brust und kann nicht mehr atmen!",
        details: "M√§nnlich, ca. 65 Jahre, akute Brustschmerzen, Atemnot, kalter Schwei√ü.",
        units: "RTW + NEF",
        priority: "PRIORIT√ÑT 1 - SOFORT",
        keywords: ["herz", "brust", "schmerzen", "atmen", "atem", "bewusstlos"],
        emotionalState: "verzweifelt",
        location: "Lindenweg 12, Einfamilienhaus"
    },
    {
        type: "VERKEHRSUNFALL",
        icon: "üöó",
        initialPanic: "Ein schlimmer Unfall! Die Autos sind total zerst√∂rt! Jemand ist eingeklemmt!",
        details: "Frontalzusammensto√ü zweier PKW. Mind. 2 Verletzte, 1 Person eingeklemmt.",
        units: "RTW + NEF + Feuerwehr (R√ºstzug) + Polizei",
        priority: "PRIORIT√ÑT 1 - SOFORT",
        keywords: ["unfall", "auto", "crash", "eingeklemmt", "blut", "verletzt"],
        emotionalState: "schockiert",
        location: "B27, H√∂he Kilometer 34, Richtung Norden"
    },
    {
        type: "BEWUSSTLOSE PERSON",
        icon: "ü´Ä",
        initialPanic: "Hier liegt jemand auf dem Boden! Er reagiert auf nichts mehr!",
        details: "Person zusammengebrochen, keine Reaktion auf Ansprache, Atmung unklar.",
        units: "RTW + First Responder",
        priority: "PRIORIT√ÑT 1 - SOFORT",
        keywords: ["bewusstlos", "liegt", "reagiert nicht", "umgefallen", "kollabiert"],
        emotionalState: "aufgeregt",
        location: "Hauptbahnhof, Bahnsteig 3"
    },
    {
        type: "H√ÑUSLICHE GEWALT",
        icon: "‚ö†Ô∏è",
        initialPanic: "Er schl√§gt sie! Ich h√∂re Schreie aus der Nachbarwohnung! Bitte kommen Sie schnell!",
        details: "Laute Schreie und Ger√§usche von Gewalt aus Nachbarwohnung. Kinder m√∂glicherweise anwesend.",
        units: "2x Streifenwagen + RTW (Bereitstellung)",
        priority: "PRIORIT√ÑT 1 - SOFORT",
        keywords: ["schl√§gt", "schreie", "gewalt", "streit", "hilfe"],
        emotionalState: "√§ngstlich",
        location: "Rosenstra√üe 8, 2. OG rechts"
    },
    {
        type: "KINDERNOTFALL",
        icon: "üë∂",
        initialPanic: "Mein Kind! Es hat etwas verschluckt und bekommt keine Luft mehr!",
        details: "Kleinkind, ca. 3 Jahre, Fremdk√∂rperaspiration, akute Atemnot, Zyanose.",
        units: "RTW + NEF (Kindernotarzt wenn verf√ºgbar)",
        priority: "PRIORIT√ÑT 1 - SOFORT",
        keywords: ["kind", "baby", "verschluckt", "atmet nicht", "blau"],
        emotionalState: "hysterisch",
        location: "Ahornweg 23, EG"
    }
];

// Anrufer-Namen
const callerNames = [
    "Maria Schneider", "Thomas Weber", "Sandra M√ºller", 
    "Klaus Fischer", "Petra Hoffmann", "Michael Braun",
    "Anna Schmidt", "Stefan Koch", "Sabine Richter"
];

// Reaktionen auf unsinnige/unpassende Fragen
const nonsenseResponses = [
    "Was?! Das ist doch jetzt v√∂llig egal! Hier ist ein NOTFALL!",
    "Sind Sie verr√ºckt?! Schicken Sie endlich jemanden!",
    "Ich verstehe die Frage nicht... K√∂nnen wir uns bitte auf das Wichtige konzentrieren?!",
    "Das ist doch jetzt nicht Ihr Ernst! Menschen brauchen HILFE!",
    "H√∂ren Sie mir √ºberhaupt zu?! Es ist ein NOTFALL!",
    "Warum fragen Sie so etwas?! Bitte helfen Sie uns!",
    "Ich... was? Nein! Bitte schicken Sie Hilfe!",
    "Das spielt doch keine Rolle! BITTE!",
    "Ich kann das jetzt nicht beantworten, verstehen Sie das nicht?!",
    "Sind Sie √ºberhaupt von der Leitstelle?! Das ist nicht relevant!"
];

// Kontextbasierte Antworten
const contextResponses = {
    location: [
        "Wir sind in der {location}! Bitte beeilen Sie sich!",
        "Die Adresse ist {location}! Wie lange dauert das noch?!",
        "{location}! Schnell, bitte!",
        "Ich bin... *atmet schwer* ...{location}!"
    ],
    name: [
        "Ich hei√üe {name}. Bitte, Sie m√ºssen uns helfen!",
        "{name}... mein Name ist {name}!",
        "*schluchzt* {name}... k√∂nnen Sie jetzt bitte jemanden schicken?!",
        "{name}. Aber das ist doch egal, HELFEN Sie uns!"
    ],
    whatHappened: [
        "{panic} Bitte kommen Sie schnell!",
        "Ich... ich wei√ü nicht genau... {panic}",
        "*Panik in der Stimme* {panic}",
        "Es ist schrecklich! {panic}"
    ],
    conscious: [
        "Ich wei√ü nicht! Er/Sie reagiert auf nichts, was ich tue!",
        "Nein... nein, ich glaube nicht... Oh Gott!",
        "Er/Sie hat die Augen zu! Ich wei√ü nicht, ob er/sie atmet!",
        "Er/Sie bewegt sich nicht mehr! HELFEN SIE!",
        "Ich bin mir nicht sicher... *weint* ...bitte beeilen Sie sich!"
    ],
    breathing: [
        "Ich... ich wei√ü nicht! Ich glaube schon... nein, warten Sie... ich bin mir nicht sicher!",
        "Ganz flach... ganz flach atmet er/sie!",
        "Ich sehe nichts! Was soll ich tun?!",
        "Ich kann das nicht erkennen! *Panik*"
    ],
    danger: [
        "Ich wei√ü nicht! Hier ist √ºberall Chaos!",
        "Ich glaube nicht... aber ich bin mir nicht sicher!",
        "Vielleicht! Ich wei√ü es nicht! Kommen Sie einfach!",
        "Nein, aber die Situation ist schlimm!"
    ],
    howMany: [
        "Ich wei√ü nicht genau... mindestens eine Person... vielleicht mehr!",
        "Eine Person auf jeden Fall! Aber hier sind noch andere Leute!",
        "Ich... ich kann das nicht z√§hlen! Bitte kommen Sie einfach!",
        "*z√§hlt hektisch* ...zwei... nein, drei Leute brauchen Hilfe!"
    ],
    stayCalm: [
        "*atmet tief* Okay... okay, ich versuche es...",
        "Wie soll ich ruhig bleiben?! Haben Sie eine Ahnung, was hier los ist?!",
        "Ich versuche es... *schluchzt* ...ich versuche es wirklich!",
        "Ja... ja, Sie haben recht... *atmet zitternd*"
    ],
    help: [
        "Ich versuche zu helfen, aber ich wei√ü nicht wie!",
        "Was soll ich tun?! Sagen Sie mir, was ich tun soll!",
        "Ich mache alles, was Sie sagen! Aber bitte schnell!",
        "Ich bin hier bei ihm/ihr... was jetzt?!"
    ],
    hurry: [
        "Bitte beeilen Sie sich! Ich wei√ü nicht, wie lange noch...!",
        "Jede Sekunde z√§hlt! BITTE!",
        "Wie lange dauert das noch?! Wir haben keine Zeit!",
        "Schnell, schnell, SCHNELL!"
    ]
};

// Emotionale Ausdr√ºcke basierend auf Zustand
const emotionalExpressions = {
    panisch: ["*schreit*", "*kreischt*", "OH GOTT!", "*hyperventiliert*"],
    verzweifelt: ["*weint*", "*schluchzt*", "*Stimme bricht*", "*fl√ºstert*"],
    schockiert: ["*stammelt*", "*Stimme zittert*", "*kann kaum sprechen*", "*stockt*"],
    aufgeregt: ["*spricht schnell*", "*hektisch*", "*aufgeregt*", "*atemlos*"],
    √§ngstlich: ["*fl√ºstert √§ngstlich*", "*Stimme zittert*", "*versteckt sich*", "*leise*"],
    hysterisch: ["*schreit hysterisch*", "*au√üer sich*", "*v√∂llig aufgel√∂st*", "*kreischt*"]
};

function addLogEntry(text, type) {
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    entry.innerHTML = text;
    consoleLog.appendChild(entry);
    scrollToBottom();
}

function addTypingIndicator() {
    const indicator = document.createElement('div');
    indicator.className = 'typing-indicator';
    indicator.id = 'typingIndicator';
    indicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
    consoleLog.appendChild(indicator);
    scrollToBottom();
}

function removeTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) indicator.remove();
}

function scrollToBottom() {
    consoleContainer.scrollTop = consoleContainer.scrollHeight;
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function getRandomItem(array) {
    return array[Math.floor(Math.random() * array.length)];
}

function addEmotionalExpression(text) {
    if (currentIncident && Math.random() > 0.4) {
        const expressions = emotionalExpressions[currentIncident.emotionalState];
        const expr = getRandomItem(expressions);
        if (Math.random() > 0.5) {
            return expr + " " + text;
        } else {
            return text + " " + expr;
        }
    }
    return text;
}

function analyzeUserInput(input) {
    const lowerInput = input.toLowerCase();
    
    // Pr√ºfe auf Schl√ºsselw√∂rter f√ºr kontextbasierte Antworten
    
    // Standort/Adresse
    if (lowerInput.includes("wo ") || lowerInput.includes("adresse") || 
        lowerInput.includes("standort") || lowerInput.includes("ort") ||
        lowerInput.includes("stra√üe") || lowerInput.includes("wo sind") ||
        lowerInput.includes("wo befinden")) {
        let response = getRandomItem(contextResponses.location);
        return response.replace("{location}", callerInfo.location);
    }
    
    // Name
    if (lowerInput.includes("name") || lowerInput.includes("wer sind sie") ||
        lowerInput.includes("wie hei√üen") || lowerInput.includes("ihr name")) {
        let response = getRandomItem(contextResponses.name);
        return response.replace("{name}", callerInfo.name);
    }
    
    // Was ist passiert
    if (lowerInput.includes("was ist passiert") || lowerInput.includes("was ist los") ||
        lowerInput.includes("erz√§hlen sie") || lowerInput.includes("was genau") ||
        lowerInput.includes("schildern") || lowerInput.includes("beschreiben")) {
        let response = getRandomItem(contextResponses.whatHappened);
        return response.replace("{panic}", currentIncident.initialPanic);
    }
    
    // Bei Bewusstsein
    if (lowerInput.includes("bewusst") || lowerInput.includes("ansprechbar") ||
        lowerInput.includes("reagiert") || lowerInput.includes("wach")) {
        return addEmotionalExpression(getRandomItem(contextResponses.conscious));
    }
    
    // Atmung
    if (lowerInput.includes("atm") || lowerInput.includes("atem") ||
        lowerInput.includes("luft")) {
        return addEmotionalExpression(getRandomItem(contextResponses.breathing));
    }
    
    // Gefahr
    if (lowerInput.includes("gefahr") || lowerInput.includes("sicher") ||
        lowerInput.includes("gef√§hrlich") || lowerInput.includes("bedroht")) {
        return addEmotionalExpression(getRandomItem(contextResponses.danger));
    }
    
    // Wie viele Personen
    if (lowerInput.includes("wie viele") || lowerInput.includes("wieviele") ||
        lowerInput.includes("anzahl") || lowerInput.includes("personen")) {
        return addEmotionalExpression(getRandomItem(contextResponses.howMany));
    }
    
    // Beruhigung
    if (lowerInput.includes("ruhig") || lowerInput.includes("beruhig") ||
        lowerInput.includes("entspann") || lowerInput.includes("tief durchatmen")) {
        return addEmotionalExpression(getRandomItem(contextResponses.stayCalm));
    }
    
    // Helfen
    if (lowerInput.includes("helfen") || lowerInput.includes("hilfe") ||
        lowerInput.includes("erste hilfe") || lowerInput.includes("was soll ich")) {
        return addEmotionalExpression(getRandomItem(contextResponses.help));
    }
    
    // Beeilen
    if (lowerInput.includes("unterwegs") || lowerInput.includes("schicke") ||
        lowerInput.includes("kommt") || lowerInput.includes("wie lange") ||
        lowerInput.includes("bald") || lowerInput.includes("schnell")) {
        return addEmotionalExpression(getRandomItem(contextResponses.hurry));
    }
    
    // Ja/Nein Fragen
    if (lowerInput.endsWith("?")) {
        if (Math.random() > 0.5) {
            const yesNo = ["Ja! Ja, ich glaube schon!", "Nein! Nein, ich wei√ü nicht!", 
                          "Ich bin mir nicht sicher!", "Vielleicht... ich wei√ü es nicht!"];
            return addEmotionalExpression(getRandomItem(yesNo));
        }
    }
    
    // Best√§tigung/Danke
    if (lowerInput.includes("danke") || lowerInput.includes("hilfe kommt") ||
        lowerInput.includes("einsatzkr√§fte")) {
        const relief = [
            "Gott sei Dank! Bitte schnell!",
            "Danke! Danke! Bitte beeilen Sie sich!",
            "Oh, endlich! Wie lange noch?!",
            "*erleichtert* Bitte, jede Sekunde z√§hlt!"
        ];
        return addEmotionalExpression(getRandomItem(relief));
    }
    
    // Unsinnige/nicht relevante Fragen -> frustrierte Reaktion
    return addEmotionalExpression(getRandomItem(nonsenseResponses));
}

async function simulateCallerResponse(userMessage) {
    addTypingIndicator();
    await sleep(1000 + Math.random() * 1500);
    removeTypingIndicator();
    
    const response = analyzeUserInput(userMessage);
    addLogEntry(response, 'anrufer');
}

async function startSimulation() {
    welcomeScreen.style.display = 'none';
    startBtn.disabled = true;
    statusDot.classList.add('active');
    statusText.textContent = 'Anruf aktiv';
    questionCount = 0;
    
    // Zuf√§lliges Szenario w√§hlen
    currentIncident = getRandomItem(incidents);
    callerInfo.name = getRandomItem(callerNames);
    callerInfo.location = currentIncident.location;
    
    addLogEntry('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'system');
    addLogEntry('üìû EINGEHENDER NOTRUF', 'system');
    addLogEntry('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'system');
    await sleep(800);
    addLogEntry('*Telefon klingelt*', 'system');
    await sleep(1500);
    addLogEntry('Verbindung hergestellt...', 'system');
    await sleep(1000);
    
    // Anrufer meldet sich zuerst panisch
    const openings = [
        `*au√üer Atem* Hallo?! Hallo, ist da jemand?! ${currentIncident.initialPanic}`,
        `${currentIncident.initialPanic} Bitte helfen Sie uns! BITTE!`,
        `*schreit ins Telefon* ${currentIncident.initialPanic} Oh Gott, oh Gott!`,
        `Hilfe! HILFE! ${currentIncident.initialPanic}`
    ];
    
    addLogEntry(addEmotionalExpression(getRandomItem(openings)), 'anrufer');
    
    await sleep(500);
    userInput.disabled = false;
    userInput.placeholder = "Ihre Frage oder Anweisung...";
    userInput.focus();
}

async function handleUserInput() {
    const input = userInput.value.trim();
    if (!input) return;
    
    addLogEntry(input, 'user');
    userInput.value = '';
    userInput.disabled = true;
    
    questionCount++;
    
    await simulateCallerResponse(input);
    
    // Nach gen√ºgend Fragen das Gespr√§ch beenden
    if (questionCount >= maxQuestions) {
        await sleep(1000);
        await endCallAndGenerateIncident();
    } else {
        await sleep(300);
        userInput.disabled = false;
        userInput.focus();
    }
}

async function endCallAndGenerateIncident() {
    userInput.disabled = true;
    userInput.placeholder = "Gespr√§ch beendet";
    
    addLogEntry('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'system');
    addLogEntry('‚úì INFORMATIONSAUFNAHME ABGESCHLOSSEN', 'system');
    addLogEntry('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'system');
    
    await sleep(1000);
    addLogEntry('Einsatz wird generiert...', 'system');
    await sleep(1500);
    
    const incidentHTML = `
        <div class="incident-title">${currentIncident.icon} ${currentIncident.type}</div>
        <div class="incident-details">
            <strong>Einsatzort:</strong> ${callerInfo.location}<br>
            <strong>Melder:</strong> ${callerInfo.name}<br>
            <strong>Lagemeldung:</strong> ${currentIncident.details}<br>
            <strong>Alarmierte Einheiten:</strong> ${currentIncident.units}<br>
            <strong>Einstufung:</strong> <span style="color: #f85149;">${currentIncident.priority}</span>
        </div>
    `;
    
    const incidentEntry = document.createElement('div');
    incidentEntry.className = 'log-entry incident';
    incidentEntry.innerHTML = incidentHTML;
    consoleLog.appendChild(incidentEntry);
    scrollToBottom();
    
    await sleep(1000);
    addLogEntry('üö® EINSATZKR√ÑFTE SOFORT ALARMIEREN!', 'alert');
    
    startTimer(30);
}

function startTimer(seconds) {
    const timerDiv = document.createElement('div');
    timerDiv.className = 'timer-display';
    timerDiv.innerHTML = `
        <div class="timer-label">‚è±Ô∏è REAKTIONSZEIT</div>
        <div class="timer-value" id="timerValue">${seconds}</div>
    `;
    consoleLog.appendChild(timerDiv);
    scrollToBottom();
    
    const timerValue = document.getElementById('timerValue');
    let remaining = seconds;
    
    timerInterval = setInterval(() => {
        remaining--;
        timerValue.textContent = remaining;
        
        if (remaining <= 10) {
            timerValue.classList.add('critical');
        }
        
        if (remaining <= 0) {
            clearInterval(timerInterval);
            timerValue.textContent = '0';
            addLogEntry('‚è±Ô∏è ZEIT ABGELAUFEN - Einheiten sollten alarmiert sein!', 'alert');
            statusDot.classList.remove('active');
            statusText.textContent = 'Simulation beendet';
            startBtn.disabled = false;
            startBtn.textContent = 'Neuer Anruf';
        }
    }, 1000);
}

function resetSimulation() {
    if (timerInterval) clearInterval(timerInterval);
    questionCount = 0;
    callerInfo = {};
    currentIncident = null;
    consoleLog.innerHTML = '';
    welcomeScreen.style.display = 'block';
    consoleLog.appendChild(welcomeScreen);
    userInput.value = '';
    userInput.disabled = true;
    userInput.placeholder = 'Ihre Frage oder Anweisung...';
    statusDot.classList.remove('active');
    statusText.textContent = 'System bereit';
    startBtn.textContent = 'Anruf starten';
}

// Event Listeners
startBtn.addEventListener('click', () => {
    if (startBtn.textContent === 'Neuer Anruf') {
        resetSimulation();
    }
    startSimulation();
});

userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !userInput.disabled) {
        handleUserInput();
    }
});
